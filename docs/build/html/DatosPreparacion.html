

<!DOCTYPE html>
<html class="writer-html5" lang="es" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Datos y Preparación &mdash; Desarrollo de un sistema de análisis financiero y sostenible del mercado bursátil europeo</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/custom.css?v=8a334cfc" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=ba61de6b"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="_static/translations.js?v=f85f4cfb"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Índice" href="genindex.html" />
    <link rel="search" title="Búsqueda" href="search.html" />
    <link rel="next" title="Modelos Predictivos" href="ModeloPredictivo.html" />
    <link rel="prev" title="Modelos Teoricos" href="MarcoTeorico.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Desarrollo de un sistema de análisis financiero y sostenible del mercado bursátil europeo
              <img src="_static/Logo.jpeg" class="logo" alt="Logotipo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Buscar documentos" aria-label="Buscar documentos" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Introduccion.html">Introducción</a></li>
<li class="toctree-l1"><a class="reference internal" href="DescripcionProblema.html">Descripción Problema</a></li>
<li class="toctree-l1"><a class="reference internal" href="MarcoTeorico.html">Modelos Teoricos</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Datos y Preparación</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#titulares-de-noticieros">Titulares de noticieros</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#modulos-y-dependencias">Módulos y dependencias</a></li>
<li class="toctree-l3"><a class="reference internal" href="#flujo-general">Flujo general</a></li>
<li class="toctree-l3"><a class="reference internal" href="#preparacion-del-procesamiento-por-medio">Preparación del procesamiento por medio</a></li>
<li class="toctree-l3"><a class="reference internal" href="#extraccion-de-titulares">Extracción de titulares</a></li>
<li class="toctree-l3"><a class="reference internal" href="#carga-del-dataframe-de-titulares-de-noticieros-en-el-datalake">Carga del DataFrame de titulares de noticieros en el DataLake</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#precios-por-tickers">Precios por tickers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#scraping-de-indices-europeos-en-tradingview">Scraping de índices europeos en TradingView</a></li>
<li class="toctree-l3"><a class="reference internal" href="#descarga-de-precios-por-empresa-diaria">Descarga de precios por empresa diaria</a></li>
<li class="toctree-l3"><a class="reference internal" href="#carga-de-los-dataframe-de-precios-por-tickers-en-el-datalake">Carga de los DataFrame de precios por tickers en el DataLake</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#estados-financieros-por-tickers">Estados Financieros por tickers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="ModeloPredictivo.html">Modelos Predictivos</a></li>
<li class="toctree-l1"><a class="reference internal" href="AutomatizacionFinanciera.html">Automatizacion Financiera</a></li>
<li class="toctree-l1"><a class="reference internal" href="Conclusiones.html">Conclusiones</a></li>
<li class="toctree-l1"><a class="reference internal" href="Bibliografia.html">Bibliografía</a></li>
<li class="toctree-l1"><a class="reference internal" href="Anexos.html">Anexos</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Desarrollo de un sistema de análisis financiero y sostenible del mercado bursátil europeo</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Datos y Preparación</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/DatosPreparacion.md.txt" rel="nofollow"> Ver código fuente de la página</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="datos-y-preparacion">
<h1>Datos y Preparación<a class="headerlink" href="#datos-y-preparacion" title="Link to this heading"></a></h1>
<p>Este trabajo integra dos fuentes complementarias para anticipar el comportamiento del precio de acciones europeas: señales de sentimiento extraídas de titulares de prensa y información cuantitativa de mercado y estados financieros. Los titulares se obtuvieron mediante scraping y de medios generalistas y económicos —BBC, ABC, El Economista, Bloomberg Europa, El País, The Times y Expansión—. Sobre estos textos se aplicó una depuración sistemática (eliminación de duplicados y de ruidos como elementos de navegación, normalización de caracteres/idiomas y control de fechas) para construir indicadores diarios de sentimiento por medio e instrumento.</p>
<p>En paralelo, los datos de mercado (OHLCV por ticker) se descargaron y consolidaron en Snowflake, armonizando formatos de fecha y símbolos, verificando huecos y coherencia (festivos, sesiones sin volumen) y, cuando procede, incorporando información contable resumida por compañía. Finalmente, se integraron ambas fuentes en un único dataset analítico a nivel (ticker, fecha) que incluye rendimientos y rezagos, volumen y métricas de sentimiento agregadas. Este conjunto sirve de base para los modelos predictivos, combinando la dimensión informativa de las noticias con la evidencia numérica del mercado para obtener señales de compra/venta más robustas.</p>
<section id="titulares-de-noticieros">
<h2>Titulares de noticieros<a class="headerlink" href="#titulares-de-noticieros" title="Link to this heading"></a></h2>
<p>Como primera fase, se recopilaron titulares de noticieros financieros y generalistas de acceso público —entre ellos El País, The Times y Bloomberg— a través de sus respectivas fuentes web y archivos digitales. Posteriormente, estos textos fueron procesados mediante técnicas de análisis de texto <span style="color:red">[aquí se puede especificar el método exacto]</span> , con el objetivo de identificar noticias relevantes capaces de influir en el comportamiento bursátil de las acciones.</p>
<p>Ejemplo de base da datos de titulares:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>fecha</p></th>
<th class="head"><p>titular</p></th>
<th class="head"><p>url_archivo</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>20250101</p></td>
<td><p>Accessibility Links</p></td>
<td><p>https://web.archive.org/web/20250101234554/https://www.thetimes.com/</p></td>
</tr>
<tr class="row-odd"><td><p>20250101</p></td>
<td><p>MiCA, entre la proteccion al usuario y la soberania monetaria</p></td>
<td><p>https://web.archive.org/web/20241227062856/https://elpais.com/economia/</p></td>
</tr>
<tr class="row-even"><td><p>20250101</p></td>
<td><p>The Year AI Broke Into Music</p></td>
<td><p>https://web.archive.org/web/20250102035656/https://www.bloomberg.com/europe</p></td>
</tr>
</tbody>
</table>
<p><img alt="Noticia times" src="_images/thetimes.png" /></p>
<p>Se ha creado un <strong>orquestador</strong> con el objetivo de coordinar el proceso de <em>scraping</em> por cada medio de comunicación y la posterior carga de los datos en <strong>Snowflake</strong>, evitando la ejecución manual de código desde la documentación. Este flujo tiene como finalidad construir una base de datos de noticias relacionadas con las empresas que cotizan en las principales bolsas de valores europeas.</p>
<p>Para la orquestación se ha utilizado la herramienta <strong>n8n</strong>, una plataforma de automatización en la que se centraliza el código encargado de realizar las solicitudes a las distintas API’s y de aplicar los modelos de análisis de sentimiento. En particular, se han empleado los siguientes modelos:</p>
<ul class="simple">
<li><p><strong>bert-base-multilingual-uncased</strong>, para el análisis de noticias en español.</p></li>
<li><p><strong>DistilRoberta-financial-sentiment</strong>, especializado en noticias financieras en inglés.</p></li>
</ul>
<p>Estos modelos generan una probabilidad asociada a cada noticia, lo que permite clasificarla como <strong>positiva</strong>, <strong>negativa</strong> o <strong>neutral</strong>. Aunque el detalle de la aplicación de los modelos se desarrolla en una sección posterior, en este apartado se describe el procedimiento de descarga de titulares desde las API’s y la construcción del <em>data lake</em> en <strong>Snowflake</strong>.</p>
<hr class="docutils" />
<section id="modulos-y-dependencias">
<h3>Módulos y dependencias<a class="headerlink" href="#modulos-y-dependencias" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">config.py</span></code></strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">NOTICIEROS</span></code>: lista de medios (URL, fuente, idioma, tabla destino)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SNOWFLAKE_CONFIG</span></code>: credenciales y parámetros de conexión</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RETRIES</span></code>, <code class="docutils literal notranslate"><span class="pre">SLEEP_BETWEEN_DIAS</span></code>: reintentos y pausas</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">scraper.py</span></code></strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">obtener_snapshot_url_directo(url,</span> <span class="pre">fecha)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">extraer_titulares(url,</span> <span class="pre">fecha,</span> <span class="pre">fuente)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">log_error(msg)</span></code></p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">snowflake_utils.py</span></code></strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">obtener_ultima_fecha_en_snowflake(config,</span> <span class="pre">tabla)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">subir_a_snowflake(df,</span> <span class="pre">config,</span> <span class="pre">tabla)</span></code></p></li>
</ul>
</li>
</ul>
</section>
<hr class="docutils" />
<section id="flujo-general">
<h3>Flujo general<a class="headerlink" href="#flujo-general" title="Link to this heading"></a></h3>
<ol class="arabic simple">
<li><p>Para cada noticiero en <code class="docutils literal notranslate"><span class="pre">config.py</span></code>, se obtiene la última fecha almacenada.</p></li>
<li><p>Se recorren los días pendientes hasta el día anterior al actual.</p></li>
<li><p>Para cada fecha: se resuelve el snapshot, se extraen titulares y se enriquecen con metadatos.</p></li>
<li><p>Se suben los nuevos registros a Snowflake.</p></li>
</ol>
</section>
<hr class="docutils" />
<section id="preparacion-del-procesamiento-por-medio">
<h3>Preparación del procesamiento por medio<a class="headerlink" href="#preparacion-del-procesamiento-por-medio" title="Link to this heading"></a></h3>
<p>En primer lugar, es necesario verificar la última fecha de carga en <strong>Snowflake</strong>, tomando como referencia el período comprendido desde <strong>enero de 2024 hasta el día inmediatamente anterior</strong>. De esta manera se garantiza la continuidad del proceso y se evitan posibles duplicidades. Este enfoque asegura la disponibilidad de comentarios recientes, lo que permite realizar un análisis actualizado y contribuye a mejorar la capacidad de predicción sobre la evolución del valor de las acciones.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">def</span><span class="w"> </span><span class="nf">obtener_ultima_fecha_en_snowflake</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">tabla</span><span class="p">):</span>
<span class="linenos"> 2</span>    <span class="n">ctx</span> <span class="o">=</span> <span class="n">snowflake</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
<span class="linenos"> 3</span>        <span class="n">user</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">],</span>
<span class="linenos"> 4</span>        <span class="n">password</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">],</span>
<span class="linenos"> 5</span>        <span class="n">account</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;account&#39;</span><span class="p">],</span>
<span class="linenos"> 6</span>        <span class="n">warehouse</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;warehouse&#39;</span><span class="p">],</span>
<span class="linenos"> 7</span>        <span class="n">database</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">],</span>
<span class="linenos"> 8</span>        <span class="n">schema</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;schema&#39;</span><span class="p">]</span>
<span class="linenos"> 9</span>    <span class="p">)</span>
<span class="linenos">10</span>    <span class="n">cs</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">11</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">12</span>        <span class="n">tabla_completa</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;schema&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">tabla</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos">13</span>        <span class="n">cs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT MAX(fecha) FROM </span><span class="si">{</span><span class="n">tabla_completa</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">14</span>        <span class="n">resultado</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<span class="linenos">15</span>        <span class="k">if</span> <span class="n">resultado</span> <span class="ow">and</span> <span class="n">resultado</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
<span class="linenos">16</span>            <span class="n">ultima_fecha</span> <span class="o">=</span> <span class="n">resultado</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">17</span>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Última fecha en Snowflake para </span><span class="si">{</span><span class="n">tabla</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ultima_fecha</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">18</span>            <span class="k">return</span> <span class="n">ultima_fecha</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">19</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">20</span>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No se encontraron registros en </span><span class="si">{</span><span class="n">tabla</span><span class="si">}</span><span class="s2">. Iniciando desde 2024-01-01.&quot;</span><span class="p">)</span>
<span class="linenos">21</span>            <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s2">&quot;20240101&quot;</span><span class="p">,</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
<span class="linenos">22</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos">23</span>        <span class="n">cs</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">24</span>        <span class="n">ctx</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<hr class="docutils" />
<p>Adicionalmente, es necesario extraer las URL correctas por cada noticiero. Para ello, se ha desarrollado la función <strong><code class="docutils literal notranslate"><span class="pre">obtener_snapshot_url(original_url,</span> <span class="pre">fecha_str)</span></code></strong>, la cual consulta la API de <strong>Wayback Machine</strong> con el objetivo de recuperar la versión archivada más cercana de una página web en una fecha determinada. El procedimiento consiste en construir la URL de la API a partir de la dirección original y la fecha solicitada, realizar una petición <code class="docutils literal notranslate"><span class="pre">GET</span></code> y procesar la respuesta en formato <strong>JSON</strong>.<br />
Si existe un <em>snapshot</em> disponible, la función devuelve la URL más próxima a la fecha indicada en formato <code class="docutils literal notranslate"><span class="pre">https</span></code>; en caso contrario, retorna <code class="docutils literal notranslate"><span class="pre">None</span></code> mostrando un mensaje informativo.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">def</span><span class="w"> </span><span class="nf">obtener_snapshot_url</span><span class="p">(</span><span class="n">original_url</span><span class="p">,</span> <span class="n">fecha_str</span><span class="p">):</span>
<span class="linenos"> 2</span>    <span class="n">wayback_api</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://archive.org/wayback/available?url=</span><span class="si">{</span><span class="n">original_url</span><span class="si">}</span><span class="s1">&amp;timestamp=</span><span class="si">{</span><span class="n">fecha_str</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="linenos"> 3</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 4</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">wayback_api</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">WAYBACK_TIMEOUT</span><span class="p">)</span>
<span class="linenos"> 5</span>        <span class="n">data</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<span class="linenos"> 6</span>        <span class="n">snapshots</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;archived_snapshots&#39;</span><span class="p">,</span> <span class="p">{})</span>
<span class="linenos"> 7</span>        <span class="k">if</span> <span class="n">snapshots</span> <span class="ow">and</span> <span class="s1">&#39;closest&#39;</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">:</span>
<span class="linenos"> 8</span>            <span class="n">url_snapshot</span> <span class="o">=</span> <span class="n">snapshots</span><span class="p">[</span><span class="s1">&#39;closest&#39;</span><span class="p">][</span><span class="s1">&#39;url&#39;</span><span class="p">]</span>
<span class="linenos"> 9</span>            <span class="k">return</span> <span class="n">url_snapshot</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;http://&quot;</span><span class="p">,</span> <span class="s2">&quot;https://&quot;</span><span class="p">)</span>
<span class="linenos">10</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">11</span>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No snapshot disponible para </span><span class="si">{</span><span class="n">original_url</span><span class="si">}</span><span class="s2"> en </span><span class="si">{</span><span class="n">fecha_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">12</span>            <span class="k">return</span> <span class="kc">None</span>
<span class="linenos">13</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">14</span>        <span class="n">log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error consultando Wayback API para </span><span class="si">{</span><span class="n">original_url</span><span class="si">}</span><span class="s2"> en </span><span class="si">{</span><span class="n">fecha_str</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">15</span>        <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="extraccion-de-titulares">
<h3>Extracción de titulares<a class="headerlink" href="#extraccion-de-titulares" title="Link to this heading"></a></h3>
<p>Una vez verificada la última fecha de carga y obtenidas las URL de las API’s, se procede con la solicitud de la información. Ahora se crea la función está diseñada para obtener los titulares de noticias desde una página web archivada en la Wayback Machine. Para ello, accede al contenido del snapshot, identifica los encabezados relevantes dentro del documento HTML y aplica reglas de filtrado para asegurar que los textos extraídos correspondan efectivamente a titulares. En función del medio, se utilizan criterios específicos de validación, y los resultados se almacenan en una lista estructurada.</p>
<p>Módulo de descarga en API’s</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">def</span><span class="w"> </span><span class="nf">extraer_titulares</span><span class="p">(</span><span class="n">snapshot_url</span><span class="p">,</span> <span class="n">fecha_str</span><span class="p">,</span> <span class="n">fuente</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 2</span>    <span class="n">titulares</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 3</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 4</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">snapshot_url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">SNAPSHOT_TIMEOUT</span><span class="p">)</span>
<span class="linenos"> 5</span>        <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">)</span>
<span class="linenos"> 6</span>        <span class="n">encabezados</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">([</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="s1">&#39;h2&#39;</span><span class="p">,</span> <span class="s1">&#39;h3&#39;</span><span class="p">])</span>
<span class="linenos"> 7</span>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">fuente</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">encabezados</span><span class="p">)</span><span class="si">}</span><span class="s2"> encabezados encontrados en </span><span class="si">{</span><span class="n">snapshot_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span>        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">encabezados</span><span class="p">:</span>
<span class="linenos">10</span>            <span class="n">texto</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">11</span>            <span class="n">clases</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="p">[]))</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
<span class="linenos">12</span>
<span class="linenos">13</span>            <span class="k">if</span> <span class="n">fuente</span> <span class="o">==</span> <span class="s2">&quot;THE TIMES&quot;</span><span class="p">:</span>
<span class="linenos">14</span>                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="bp">cls</span> <span class="ow">in</span> <span class="n">clases</span> <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="p">[</span>
<span class="linenos">15</span>                    <span class="s1">&#39;responsive__HeadlineContainer-sc-3t8ix5-3&#39;</span><span class="p">,</span>
<span class="linenos">16</span>                    <span class="s1">&#39;responsive__Heading-sc-1k9kzho-1&#39;</span><span class="p">,</span>
<span class="linenos">17</span>                    <span class="s1">&#39;responsive__Title-sc-1ij0d4n-5&#39;</span>
<span class="linenos">18</span>                <span class="p">])</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">texto</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
<span class="linenos">19</span>                    <span class="n">titulares</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<span class="linenos">20</span>                        <span class="s2">&quot;fecha&quot;</span><span class="p">:</span> <span class="n">fecha_str</span><span class="p">,</span>
<span class="linenos">21</span>                        <span class="s2">&quot;titular&quot;</span><span class="p">:</span> <span class="n">texto</span><span class="p">,</span>
<span class="linenos">22</span>                        <span class="s2">&quot;url_archivo&quot;</span><span class="p">:</span> <span class="n">snapshot_url</span>
<span class="linenos">23</span>                    <span class="p">})</span>
<span class="linenos">24</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">25</span>                <span class="k">if</span> <span class="n">texto</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">texto</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
<span class="linenos">26</span>                    <span class="n">titulares</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<span class="linenos">27</span>                        <span class="s2">&quot;fecha&quot;</span><span class="p">:</span> <span class="n">fecha_str</span><span class="p">,</span>
<span class="linenos">28</span>                        <span class="s2">&quot;titular&quot;</span><span class="p">:</span> <span class="n">texto</span><span class="p">,</span>
<span class="linenos">29</span>                        <span class="s2">&quot;url_archivo&quot;</span><span class="p">:</span> <span class="n">snapshot_url</span>
<span class="linenos">30</span>                    <span class="p">})</span>
<span class="linenos">31</span>
<span class="linenos">32</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">33</span>        <span class="n">log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">fuente</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;GENERAL&#39;</span><span class="si">}</span><span class="s2">] Error accediendo a snapshot: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">34</span>
<span class="linenos">35</span>    <span class="k">return</span> <span class="n">titulares</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="carga-del-dataframe-de-titulares-de-noticieros-en-el-datalake">
<h3>Carga del DataFrame de titulares de noticieros en el DataLake<a class="headerlink" href="#carga-del-dataframe-de-titulares-de-noticieros-en-el-datalake" title="Link to this heading"></a></h3>
<p>Por último, se valida si el <strong>DataFrame</strong> contiene información; en caso de estar vacío, no se ejecuta ninguna acción.<br />
En caso contrario, se transforma la columna de fecha al tipo de dato adecuado (<code class="docutils literal notranslate"><span class="pre">datetime.date</span></code>) y se establece la conexión con <strong>Snowflake</strong> mediante las credenciales configuradas en el entorno.</p>
<p>Si la tabla de destino no existe, esta se crea con un esquema predefinido que incluye los campos: <strong>fecha</strong>, <strong>titular de la noticia</strong>, <strong>URL del snapshot</strong>, <strong>fuente</strong> e <strong>idioma</strong>. Posteriormente, se realiza una inserción en bloque de todos los registros del DataFrame, lo que permite almacenar de forma eficiente los titulares extraídos de los medios archivados, garantizando su disponibilidad para procesos posteriores de análisis o visualización.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>FECHA</p></th>
<th class="head"><p>TITULAR</p></th>
<th class="head"><p>URL_ARCHIVO</p></th>
<th class="head"><p>FUENTE</p></th>
<th class="head"><p>IDIOMA</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>2024-01-16</p></td>
<td><p>España desoye a Europa y se resiste a crear un consejo de la productividad</p></td>
<td><p><a class="reference external" href="https://web.archive.org/web/20240119085343/https://www.abc.es/economia/">Link</a></p></td>
<td><p>ABC</p></td>
<td><p>es</p></td>
</tr>
<tr class="row-odd"><td><p>2024-01-16</p></td>
<td><p>Un patinazo de Montoro aboca a Hacienda a pagar devoluciones millonarias a las grandes empresas</p></td>
<td><p><a class="reference external" href="https://web.archive.org/web/20240119085343/https://www.abc.es/economia/">Link</a></p></td>
<td><p>ABC</p></td>
<td><p>es</p></td>
</tr>
<tr class="row-even"><td><p>2024-01-16</p></td>
<td><p>Cataluña enfila 2024 con 10.000 empresas fugadas tras el “procés”</p></td>
<td><p><a class="reference external" href="https://web.archive.org/web/20240119085343/https://www.abc.es/economia/">Link</a></p></td>
<td><p>ABC</p></td>
<td><p>es</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<hr class="docutils" />
<section id="precios-por-tickers">
<h2>Precios por tickers<a class="headerlink" href="#precios-por-tickers" title="Link to this heading"></a></h2>
<p>En el análisis financiero, en primer lugar se necesitan los tickers sobre los que se realizará el estudio. Para este trabajo se han recopilado los tickers de bolsas de valores europeas, que se muestran a continuación. En total son ocho, cada una con sus respectivos tickers, y el análisis se limitará únicamente a las acciones que forman parte de los índices de dichos mercados.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>País</p></th>
<th class="head"><p>Índice</p></th>
<th class="head"><p>Exchange Aceptado</p></th>
<th class="head"><p>Sufijo Yahoo</p></th>
<th class="head"><p>Número Esperado</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>España</p></td>
<td><p>IBEX 35</p></td>
<td><p>BME</p></td>
<td><p>.MC</p></td>
<td><p>35</p></td>
</tr>
<tr class="row-odd"><td><p>Alemania</p></td>
<td><p>DAX 40</p></td>
<td><p>XETR</p></td>
<td><p>.DE</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-even"><td><p>Francia</p></td>
<td><p>CAC 40</p></td>
<td><p>EURONEXT</p></td>
<td><p>.PA</p></td>
<td><p>39</p></td>
</tr>
<tr class="row-odd"><td><p>Italia</p></td>
<td><p>FTSE MIB</p></td>
<td><p>MIL</p></td>
<td><p>.MI</p></td>
<td><p>40</p></td>
</tr>
<tr class="row-even"><td><p>Países Bajos</p></td>
<td><p>AEX</p></td>
<td><p>EURONEXT</p></td>
<td><p>.AS</p></td>
<td><p>25</p></td>
</tr>
<tr class="row-odd"><td><p>Reino Unido</p></td>
<td><p>FTSE 100</p></td>
<td><p>LSE</p></td>
<td><p>.L</p></td>
<td><p>100</p></td>
</tr>
<tr class="row-even"><td><p>Suecia</p></td>
<td><p>OMXS30</p></td>
<td><p>OMXSTO</p></td>
<td><p>.ST</p></td>
<td><p>30</p></td>
</tr>
<tr class="row-odd"><td><p>Suiza</p></td>
<td><p>SMI</p></td>
<td><p>SIX</p></td>
<td><p>.SW</p></td>
<td><p>21</p></td>
</tr>
</tbody>
</table>
<section id="scraping-de-indices-europeos-en-tradingview">
<h3>Scraping de índices europeos en TradingView<a class="headerlink" href="#scraping-de-indices-europeos-en-tradingview" title="Link to this heading"></a></h3>
<p>En una primera etapa resulta necesario extraer los tickers representativos de las principales bolsas europeas. Para ello se emplea la API de TradingView, ampliamente utilizada en el ámbito del análisis financiero, implementando la función scrape_country como componente orquestador del proceso. Esta función integra, por un lado, <code class="docutils literal notranslate"><span class="pre">fetch_html</span></code>, encargada de recuperar el código HTML de las páginas de TradingView, y por otro, <code class="docutils literal notranslate"><span class="pre">extract_rows_precise</span></code>, que a través de la librería BeautifulSoup identifica los nombres y tickers de las compañías, filtra los resultados según el mercado de interés, elimina duplicados y descarta instrumentos no relevantes como ETFs o futuros. Finalmente, scrape_country consolida ambos procedimientos para cada índice bursátil, generando un DataFrame estandarizado con el ticker en formato Yahoo Finance, el nombre depurado de la empresa, el país y el símbolo local, lo que permite conformar una base de datos estructurada y preparada para su posterior almacenamiento en Snowflake y para los análisis financieros avanzados.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">def</span><span class="w"> </span><span class="nf">scrape_country</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="linenos"> 2</span>    <span class="n">html</span> <span class="o">=</span> <span class="n">fetch_html</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;components_url&quot;</span><span class="p">])</span>
<span class="linenos"> 3</span>    <span class="n">pairs</span> <span class="o">=</span> <span class="n">extract_rows_precise</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;accept_exchanges&quot;</span><span class="p">])</span>
<span class="linenos"> 4</span>    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span>
<span class="linenos"> 5</span>    <span class="n">exp</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;expected_count&quot;</span><span class="p">]</span>
<span class="linenos"> 6</span>    <span class="k">if</span> <span class="n">n</span> <span class="o">!=</span> <span class="n">exp</span><span class="p">:</span>
<span class="linenos"> 7</span>        <span class="c1"># tolera ±2 y avisa (TV puede variar 1–2 componentes)</span>
<span class="linenos"> 8</span>        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">exp</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
<span class="linenos"> 9</span>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[WARN] </span><span class="si">{</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;pais&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> componentes (esperados </span><span class="si">{</span><span class="n">exp</span><span class="si">}</span><span class="s2">). Continuando...&quot;</span><span class="p">)</span>
<span class="linenos">10</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">11</span>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ERROR] </span><span class="si">{</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;pais&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> componentes (esperados </span><span class="si">{</span><span class="n">exp</span><span class="si">}</span><span class="s2">). Intento de continuar...&quot;</span><span class="p">)</span>
<span class="linenos">12</span>    <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">13</span>    <span class="k">for</span> <span class="n">exch</span><span class="p">,</span> <span class="n">sym</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
<span class="linenos">14</span>        <span class="n">base_for_yahoo</span> <span class="o">=</span> <span class="n">yahoo_ticker_from_local</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;pais&quot;</span><span class="p">])</span>
<span class="linenos">15</span>        <span class="n">yahoo</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_for_yahoo</span><span class="si">}{</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;yahoo_suffix&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos">16</span>        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<span class="linenos">17</span>            <span class="s2">&quot;TICKER_YAHOO&quot;</span><span class="p">:</span> <span class="n">yahoo</span><span class="p">,</span>
<span class="linenos">18</span>            <span class="s2">&quot;NOMBRE&quot;</span><span class="p">:</span> <span class="n">clean_company_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sym</span><span class="p">),</span>
<span class="linenos">19</span>            <span class="s2">&quot;PAIS&quot;</span><span class="p">:</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;pais&quot;</span><span class="p">],</span>
<span class="linenos">20</span>            <span class="s2">&quot;TICKET&quot;</span><span class="p">:</span> <span class="n">base_for_yahoo</span>
<span class="linenos">21</span>        <span class="p">})</span>
<span class="linenos">22</span>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>  <span class="c1"># respeta un poco más a TV</span>
<span class="linenos">23</span>    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;TICKER_YAHOO&quot;</span><span class="p">,</span> <span class="s2">&quot;NOMBRE&quot;</span><span class="p">,</span> <span class="s2">&quot;PAIS&quot;</span><span class="p">,</span> <span class="s2">&quot;TICKET&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>Ejemplos de DataFrame de stickers:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>NOMBRE_EMPRESA</p></th>
<th class="head"><p>PAIS</p></th>
<th class="head"><p>INDEX</p></th>
<th class="head"><p>TICKER</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ACS, ACTIVIDADES DE CONSTRUCCION Y SERVICIOS, S.A.</p></td>
<td><p>España</p></td>
<td><p>IBEX35</p></td>
<td><p>ACS</p></td>
</tr>
<tr class="row-odd"><td><p>ACERINOX, S.A.</p></td>
<td><p>España</p></td>
<td><p>IBEX35</p></td>
<td><p>ACX</p></td>
</tr>
<tr class="row-even"><td><p>AENA, S.M.E., S.A.</p></td>
<td><p>España</p></td>
<td><p>IBEX35</p></td>
<td><p>AENA</p></td>
</tr>
</tbody>
</table>
</section>
<section id="descarga-de-precios-por-empresa-diaria">
<h3>Descarga de precios por empresa diaria<a class="headerlink" href="#descarga-de-precios-por-empresa-diaria" title="Link to this heading"></a></h3>
<p>Una vez obtenida la lista de tickers, se procede a la consulta de la información histórica en Yahoo Finance mediante la función <code class="docutils literal notranslate"><span class="pre">download_batch</span></code>. Dicha función permite recopilar de forma automatizada los precios diarios de apertura, cierre, máximo y mínimo, además del volumen de acciones negociadas, vinculando cada registro con su fecha correspondiente. Posteriormente, los datos son transformados y estandarizados en un formato homogéneo, lo que garantiza su integración sin inconsistencias dentro del flujo de almacenamiento en el DataLake y asegura la disponibilidad de un conjunto de información fiable para el análisis y la modelización posteriores.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">def</span><span class="w"> </span><span class="nf">download_batch</span><span class="p">(</span><span class="n">tickers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_excl</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="linenos"> 2</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">tickers</span><span class="p">:</span>
<span class="linenos"> 3</span>        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;TICKER&quot;</span><span class="p">,</span><span class="s2">&quot;CLOSE&quot;</span><span class="p">,</span><span class="s2">&quot;HIGH&quot;</span><span class="p">,</span><span class="s2">&quot;LOW&quot;</span><span class="p">,</span><span class="s2">&quot;OPEN&quot;</span><span class="p">,</span><span class="s2">&quot;VOLUME&quot;</span><span class="p">,</span><span class="s2">&quot;FECHA&quot;</span><span class="p">])</span>
<span class="linenos"> 4</span>    <span class="n">df</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span>
<span class="linenos"> 5</span>        <span class="n">tickers</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_excl</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="s2">&quot;1d&quot;</span><span class="p">,</span>
<span class="linenos"> 6</span>        <span class="n">group_by</span><span class="o">=</span><span class="s2">&quot;ticker&quot;</span><span class="p">,</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="kc">True</span>
<span class="linenos"> 7</span>    <span class="p">)</span>
<span class="linenos"> 8</span>    <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 9</span>    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
<span class="linenos">10</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">11</span>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
<span class="linenos">12</span>                <span class="k">if</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
<span class="linenos">13</span>                    <span class="k">continue</span>
<span class="linenos">14</span>                <span class="n">dft</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
<span class="linenos">15</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">16</span>                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;Open&quot;</span><span class="p">,</span><span class="s2">&quot;High&quot;</span><span class="p">,</span><span class="s2">&quot;Low&quot;</span><span class="p">,</span><span class="s2">&quot;Close&quot;</span><span class="p">,</span><span class="s2">&quot;Volume&quot;</span><span class="p">}:</span>
<span class="linenos">17</span>                    <span class="n">dft</span> <span class="o">=</span> <span class="n">df</span>
<span class="linenos">18</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">19</span>                    <span class="k">continue</span>
<span class="linenos">20</span>            <span class="n">dft</span> <span class="o">=</span> <span class="n">dft</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
<span class="linenos">21</span>                <span class="s2">&quot;Date&quot;</span><span class="p">:</span><span class="s2">&quot;FECHA&quot;</span><span class="p">,</span><span class="s2">&quot;Open&quot;</span><span class="p">:</span><span class="s2">&quot;OPEN&quot;</span><span class="p">,</span><span class="s2">&quot;High&quot;</span><span class="p">:</span><span class="s2">&quot;HIGH&quot;</span><span class="p">,</span><span class="s2">&quot;Low&quot;</span><span class="p">:</span><span class="s2">&quot;LOW&quot;</span><span class="p">,</span><span class="s2">&quot;Close&quot;</span><span class="p">:</span><span class="s2">&quot;CLOSE&quot;</span><span class="p">,</span><span class="s2">&quot;Volume&quot;</span><span class="p">:</span><span class="s2">&quot;VOLUME&quot;</span>
<span class="linenos">22</span>            <span class="p">})</span>
<span class="linenos">23</span>            <span class="n">dft</span><span class="p">[</span><span class="s2">&quot;TICKER&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
<span class="linenos">24</span>            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dft</span><span class="p">[[</span><span class="s2">&quot;TICKER&quot;</span><span class="p">,</span><span class="s2">&quot;CLOSE&quot;</span><span class="p">,</span><span class="s2">&quot;HIGH&quot;</span><span class="p">,</span><span class="s2">&quot;LOW&quot;</span><span class="p">,</span><span class="s2">&quot;OPEN&quot;</span><span class="p">,</span><span class="s2">&quot;VOLUME&quot;</span><span class="p">,</span><span class="s2">&quot;FECHA&quot;</span><span class="p">]])</span>
<span class="linenos">25</span>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">26</span>            <span class="k">continue</span>
<span class="linenos">27</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
<span class="linenos">28</span>        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;TICKER&quot;</span><span class="p">,</span><span class="s2">&quot;CLOSE&quot;</span><span class="p">,</span><span class="s2">&quot;HIGH&quot;</span><span class="p">,</span><span class="s2">&quot;LOW&quot;</span><span class="p">,</span><span class="s2">&quot;OPEN&quot;</span><span class="p">,</span><span class="s2">&quot;VOLUME&quot;</span><span class="p">,</span><span class="s2">&quot;FECHA&quot;</span><span class="p">])</span>
<span class="linenos">29</span>    <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CLOSE&quot;</span><span class="p">])</span>
<span class="linenos">30</span>    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;FECHA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;FECHA&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
<span class="linenos">31</span>    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;CLOSE&quot;</span><span class="p">,</span><span class="s2">&quot;HIGH&quot;</span><span class="p">,</span><span class="s2">&quot;LOW&quot;</span><span class="p">,</span><span class="s2">&quot;OPEN&quot;</span><span class="p">]:</span>
<span class="linenos">32</span>        <span class="n">out</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
<span class="linenos">33</span>    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;VOLUME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;VOLUME&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;Int64&quot;</span><span class="p">)</span>
<span class="linenos">34</span>    <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CLOSE&quot;</span><span class="p">,</span><span class="s2">&quot;HIGH&quot;</span><span class="p">,</span><span class="s2">&quot;LOW&quot;</span><span class="p">,</span><span class="s2">&quot;OPEN&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>Ejemplos de DataFrame de Precios por accion</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>TICKER</p></th>
<th class="head"><p>CLOSE</p></th>
<th class="head"><p>HIGH</p></th>
<th class="head"><p>LOW</p></th>
<th class="head"><p>OPEN</p></th>
<th class="head"><p>VOLUME</p></th>
<th class="head"><p>FECHA</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>INGA.AS</p></td>
<td><p>6.59100008</p></td>
<td><p>6.656000137</p></td>
<td><p>6.429999828</p></td>
<td><p>6.5</p></td>
<td><p>17736691</p></td>
<td><p>10/23/20</p></td>
</tr>
<tr class="row-odd"><td><p>GLE.PA</p></td>
<td><p>23.84499931</p></td>
<td><p>24.03000069</p></td>
<td><p>23.65500069</p></td>
<td><p>23.87000084</p></td>
<td><p>2111582</p></td>
<td><p>10/28/24</p></td>
</tr>
<tr class="row-even"><td><p>LAND.L</p></td>
<td><p>686.2000122</p></td>
<td><p>697.2000122</p></td>
<td><p>686.2000122</p></td>
<td><p>690.5999756</p></td>
<td><p>1574957</p></td>
<td><p>06/17/21</p></td>
</tr>
</tbody>
</table>
</section>
<section id="carga-de-los-dataframe-de-precios-por-tickers-en-el-datalake">
<h3>Carga de los DataFrame de precios por tickers en el DataLake<a class="headerlink" href="#carga-de-los-dataframe-de-precios-por-tickers-en-el-datalake" title="Link to this heading"></a></h3>
<p>Finalmente, se lleva a cabo un proceso de verificación de la última fecha de actualización registrada en el DataLake, tanto para los precios como para los tickers disponibles. A partir de dicha referencia temporal, se descargan únicamente los datos faltantes hasta el día inmediatamente anterior, con el fin de mantener una ingesta incremental que garantice la actualización diaria del repositorio. Este enfoque asegura la coherencia y completitud del histórico financiero, a la vez que proporciona una base de datos confiable, estructurada y permanentemente actualizada para los posteriores análisis y modelado mediante técnicas de machine learning.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">def</span><span class="w"> </span><span class="nf">merge_with_temp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="linenos"> 2</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Carga df a TMP_PRICES con write_pandas y luego MERGE → sin límite de expresiones.&quot;&quot;&quot;</span>
<span class="linenos"> 3</span>    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
<span class="linenos"> 4</span>        <span class="k">return</span>
<span class="linenos"> 5</span>    <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;TICKER&quot;</span><span class="p">,</span><span class="s2">&quot;CLOSE&quot;</span><span class="p">,</span><span class="s2">&quot;HIGH&quot;</span><span class="p">,</span><span class="s2">&quot;LOW&quot;</span><span class="p">,</span><span class="s2">&quot;OPEN&quot;</span><span class="p">,</span><span class="s2">&quot;VOLUME&quot;</span><span class="p">,</span><span class="s2">&quot;FECHA&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos"> 6</span>    <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
<span class="linenos"> 7</span>        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CREATE OR REPLACE TEMP TABLE TMP_PRICES LIKE </span><span class="si">{</span><span class="n">PRICES_TABLE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos"> 8</span>    <span class="n">ok</span><span class="p">,</span> <span class="n">nchunks</span><span class="p">,</span> <span class="n">nrows</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">write_pandas</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;TMP_PRICES&quot;</span><span class="p">,</span> <span class="n">quote_identifiers</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos"> 9</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
<span class="linenos">10</span>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;write_pandas falló al cargar TMP_PRICES.&quot;</span><span class="p">)</span>
<span class="linenos">11</span>    <span class="n">merge_sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="linenos">12</span><span class="s2">        MERGE INTO </span><span class="si">{</span><span class="n">PRICES_TABLE</span><span class="si">}</span><span class="s2"> t</span>
<span class="linenos">13</span><span class="s2">        USING TMP_PRICES s</span>
<span class="linenos">14</span><span class="s2">          ON t.TICKER = s.TICKER AND t.FECHA = s.FECHA</span>
<span class="linenos">15</span><span class="s2">        WHEN MATCHED THEN UPDATE SET</span>
<span class="linenos">16</span><span class="s2">          t.CLOSE = s.CLOSE, t.HIGH = s.HIGH, t.LOW = s.LOW, t.OPEN = s.OPEN, t.VOLUME = s.VOLUME</span>
<span class="linenos">17</span><span class="s2">        WHEN NOT MATCHED THEN</span>
<span class="linenos">18</span><span class="s2">          INSERT (TICKER, CLOSE, HIGH, LOW, OPEN, VOLUME, FECHA)</span>
<span class="linenos">19</span><span class="s2">          VALUES (s.TICKER, s.CLOSE, s.HIGH, s.LOW, s.OPEN, s.VOLUME, s.FECHA)</span>
<span class="linenos">20</span><span class="s2">    &quot;&quot;&quot;</span>
<span class="linenos">21</span>    <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
<span class="linenos">22</span>        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">merge_sql</span><span class="p">)</span>
<span class="linenos">23</span>        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<section id="estados-financieros-por-tickers">
<h2>Estados Financieros por tickers<a class="headerlink" href="#estados-financieros-por-tickers" title="Link to this heading"></a></h2>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Pie de página">
        <a href="MarcoTeorico.html" class="btn btn-neutral float-left" title="Modelos Teoricos" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Anterior</a>
        <a href="ModeloPredictivo.html" class="btn btn-neutral float-right" title="Modelos Predictivos" accesskey="n" rel="next">Siguiente <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Derechos de autor 2025, Julia Escudero, Marco Mendieta, Marco Pacora, Piero Rios, Juan Carlos Romero.</p>
  </div>

  Compilado con <a href="https://www.sphinx-doc.org/">Sphinx</a> usando un
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">tema</a>
    proporcionado por <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>